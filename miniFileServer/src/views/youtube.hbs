<div class="dialog-form">
    <div id="containerForm" class="contrainerInterno">
        <h3 id="titulo">Procurar Música</h3>
        <div id="div_search" class="div_row">
            <input id="search_field" name="palavra" placeholder="Pesquise aqui ou cole o link do vídeo">
            <button id="btnCommand">Buscar</button>
        </div>
        <div id="div_itens" class="scroll_style">
        </div>
    </div>
</div>

<div id="dialogMusic" class="dialog-form">
    <div id="dialogMusicInterno" class="contrainerInterno">
        <div class="div_dialog_section">
            <label id="dialog-title"></label>
            <audio controls name="media" preload="none">
                <source type="audio/mpeg">
            </audio>
        </div>
        <div class="div_dialog_section">
            <button id="btnBaixar">Baixar</button>
            <label id="label_link">Carregando...</label>
        </div>
    </div>
</div>

<script defer>
    const state = {
        wait: false,
        video: {
            id: null,
            title: null
        },
        idTimeOut: null,
        musicAction: false
    }

    function isVideoURL(frase) {
        return frase.includes("youtube.com/watch?v=")
    }

    function showMusicAction() {
        if (state.video.id === null) return;
        state.musicAction = true

        document.getElementById("dialogMusic").style.display = "flex"

        //atualizando nome
        document.querySelector("#dialog-title").textContent = state.video.title

        //atualizar player de música
        document.querySelector("source").src = `${window.location.origin}/api/${state.video.id}`
        document.querySelector("audio").load()

        //obter link da música
        $.ajax({
            url: `/api/youtube/get_link/${state.video.id}`,
            type: "GET",
            success: function (data) {
                $("#label_link").html(window.location.origin + data.url)
            },
            error: function (data) {
                if (data.status == 404) alert("Vídeo não encontrado")
                else alert("Erro desconhecido")
                hideMusicAction()
            },
        })
    }

    function hideMusicAction() {
        state.musicAction = false
        document.querySelector("audio").pause()
        document.getElementById("dialogMusic").style.display = "none"
    }

    function getVideoId(url) {
        let lookFor = "watch?v="
        let indexInit = url.indexOf(lookFor) + lookFor.length
        let indexEnd = url.length

        if (url.includes("&list=")) {
            lookFor = "&list="
            indexEnd = url.indexOf(lookFor)
        }

        return url.slice(indexInit, indexEnd)
    }

    function addVideoButton(video) {
        const divPai = document.getElementById("div_itens")

        const mydiv = document.createElement("div")
        mydiv.className = "div_row"

        const mybutton = document.createElement("button")
        mybutton.textContent = video.title
        mybutton.type = "button"

        mybutton.addEventListener("click", () => {
            state.video.id = video.id
            state.video.title = video.title
            showMusicAction()
        })

        mydiv.appendChild(mybutton)
        divPai.appendChild(mydiv)
    }

    function onReceiveData(data) {
        $("#div_itens").empty()

        for (let video of data.videos) {
            //let link = `/api/youtube/convert/${video.id}`
            addVideoButton(video)
        }
    }

    $("#dialogMusicInterno").click((e) => e.stopPropagation())

    $("#dialogMusic").click(() => {
        hideMusicAction()
    })

    $("#btnBaixar").click(() => {
        if (state.video.id === null) return;

        hideMusicAction()

        let link = `/api/youtube/get/${state.video.id}`
        window.location.href = link
    })

    $("#btnCommand").click(() => {
        const inputObj = $("#search_field")

        if (state.idTimeOut !== null) return alert("Espere um momento")

        if (isVideoURL(inputObj.val())) {
            let videoId = encodeURIComponent(getVideoId(inputObj.val()))
            window.location.href = `/api/youtube/get/${videoId}`
            return;
        }

        if (inputObj.val()) {
            showLoading({ backColor: '#ffffffaa', text: "Buscando..." })

            state.idTimeOut = setTimeout(() => {
                hideLoading()
                alert("Erro desconhecido, tente novamente mais tarde")
                window.location.href = '/'
            }, 15000)

            $.ajax({
                url: "/api/youtube/search",
                type: "POST",
                data: { frase: inputObj.val() },
                success: function (data) {
                    onReceiveData(data)
                },
                error: function (data) {
                    alert("Erro desconhecido")
                },
            }).done(() => {
                clearTimeout(state.idTimeOut)
                state.idTimeOut = null
                hideLoading()
            })
        } else {
            alert("Campo de busca em branco")
        }
    })

    window.onload = () => {
        addGoBackButton("containerForm", "/")

        document.addEventListener("keydown", (event) => {
            if (event.key == "Enter" && !state.musicAction) {
                $("#btnCommand").click()
            }
        })
    }

    window.onbeforeunload = () => {
        if (state.idTimeOut !== null) clearTimeout(state.idTimeOut)
    }
</script>

<style>
    body {
        overflow: hidden;
    }

    .dialog-form {
        display: flex;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }

    .dialog-form > .contrainerInterno {
        display: flex;
        flex-direction: column;
        background-color: #f5f5f5;
        padding: 20px;
        border-radius: 20px;
        box-shadow: 5px 10px 8px 10px #888888;

        width: 60vw;
        height: 60vh;

        min-width: 250px;
        min-height: 250px;
        max-width: 700px;
        max-height: 500px;

        align-items: center;
        overflow: hidden;
    }

    #div_titulo {
        flex-direction: column;
        align-items: center;
    }

    #div_titulo > h3 {
        color: #333;
        padding: 0;
        margin: 0;
        text-align: center;
    }

    #div_itens {
        display: flex;
        flex-direction: column;

        width: 100%;
        height: 100%;

        align-items: center;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .div_row {
        display: flex;
        width: 100%;
        height: 8vh;
        justify-content: center;
        margin: 2px;

        min-height: 50px;
        max-height: 100px;
    }

    #div_search {
        margin-bottom: 10px;
    }

    #div_search > input {
        display: flex;
        width: 100%;

        border-width: 0px;
        border-radius: 15px;
        outline: 0px;
        text-align: center;
    
        font-size: larger;

        background-color: #e5e5e5;
        color: #333;
    }

    #div_search > input::placeholder {
        color: #999;
    }

    button {
        display: flex;

        border-radius: 15px;
        border-width: 0px;
        width: 100%;

        align-items: center;
        justify-content: center;

        background-color: rgb(211, 211, 211);
        color: #333;
        font-size: medium;
    }

    button:hover {
        background-color: rgb(0, 255, 128);
    }

    #btnCommand {
        background-color: rgb(0, 78, 55);
        color: rgb(255, 255, 255);
        width: 25%;
        margin-left: 5px;
    }

    #btnCommand:hover {
        background-color: rgb(0, 255, 128);
        color: rgb(0, 0, 0);
    }
</style>

<style>
    #dialogMusic {
        display: none;
        background-color: #00000022;
    }

    #dialogMusicInterno {
        width: 30vw;
        height: 15vw;

        min-width: 125px;
        min-height: 90px;
        
        max-height: 300px;
    }

    .div_dialog_section {
        display: flex;
        width: 100%;
        flex-direction: column;
        height: 100%;
        align-items: center;
    }

    #div_link {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    #div_link > #label_title_link {
        color: #333;
    }

    #label_link {
        padding: 5px;
        padding-left: 15px;
        padding-right: 15px;
        border-radius: 15px;
        font-size: large;
        background-color: #eaeaea;
        color: #050;
        margin: 3px;
    }

    #btnBaixar {
        height: 80%;
        max-height: 80px;
        font-size: large;
        font-weight: bold;
        color: #555;
    }

    audio {
        width: 100%;
        height: 80%;
    }

    #dialog-title {
        color: #333;
        font-size: large;
        text-align: center;
    }
</style>